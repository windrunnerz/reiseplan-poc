{% extends "base.html" %}
{% block title %}Reiseplan Generator{% endblock %}

{% block sidebar %}
  <div class="page-sidebar-wrapper">
    <aside class="page-sidebar">
      <h3>üß≠ Beispielroute</h3>
      <ol>
        {% for ort in demo_pfad %}
          <li>{{ ort | capitalize }}</li>
        {% endfor %}
      </ol>
      <p style="margin-top: 1em; font-size: 0.9em;">

      </p>
    </aside>
  </div>
{% endblock %}

{% block content %}
  <h1>üåç Automatischer Reiseplan</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-messages">
        {% for msg in messages %}
          <p>{{ msg|safe }}</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form action="/reiseplan" method="POST" class="card">
    <h3>Start & Ziel</h3>

    <label for="start">Start-Ort:</label>
    <select name="start" id="start">
      <option value="" selected disabled>-- Start w√§hlen --</option>
      {% for ort in start_orte %}
        <option value="{{ ort | lower }}">{{ ort }}</option>
      {% endfor %}
    </select>

    <label for="ziel" class="mt-1">Ziel-Ort:</label>
    <select name="ziel" id="ziel">
      <option value="" disabled selected>-- Bitte Start w√§hlen --</option>
    </select>

    <label for="moegliche_routen" class="mt-2">M√∂gliche Routen:</label>
    <div class="form-section" id="routen-container">
      <p class="placeholder">Bitte Start- und Zielort w√§hlen.</p>
    </div>

    <div class="mt-2 text-center">
      <button type="submit" class="btn">Reiseplan anzeigen</button>
    </div>
  </form>

  <form action="{{ url_for('add_baustein') }}" method="get" class="mt-3 text-center">
    <button type="submit" class="btn">‚ûï Neuen Baustein hinzuf√ºgen</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const startSelect = document.getElementById("start");
      const zielSelect = document.getElementById("ziel");
      const container = document.querySelector("#routen-container");

      async function updateMoeglicheRouten() {
        const start = startSelect.value;
        const ziel = zielSelect.value;
        if (!start || !ziel) return;

        const res = await fetch(`/api/moegliche_routen?start=${start}&ziel=${ziel}`);
        const moegliche_routen = await res.json();

        container.innerHTML = ""; // reset

        if (moegliche_routen.length === 0) {
          container.innerHTML = "<p>Keine Routen verf√ºgbar.</p>";
          return;
        }

        moegliche_routen.forEach(route => {
          const label = document.createElement("label");
          label.innerHTML = `
            <input type="radio" name="moegliche_route" value="${route}">
            ${route}
          `;
          container.appendChild(label);
        });
      }

      startSelect.addEventListener("change", updateMoeglicheRouten);
      zielSelect.addEventListener("change", updateMoeglicheRouten);
    });

    document.addEventListener("DOMContentLoaded", () => {
      const startSelect = document.getElementById("start");
      const zielSelect = document.getElementById("ziel");

      async function updateZielOrte() {
        const start = startSelect.value;
        zielSelect.innerHTML = ""; // reset

        const defaultOption = document.createElement("option");
        defaultOption.textContent = "-- Bitte Ziel w√§hlen --"; // leerer Default
        defaultOption.value = "";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        zielSelect.appendChild(defaultOption);

        if (!start) {
          const opt = document.createElement("option");
          opt.textContent = "-- Bitte Start w√§hlen --";
          opt.disabled = true;
          opt.selected = true;
          zielSelect.appendChild(opt);
          return;
        }

        const res = await fetch(`/api/ziele?start=${start}`);
        const ziele = await res.json();

        if (ziele.length === 0) {
          const opt = document.createElement("option");
          opt.textContent = "Keine Ziele verf√ºgbar";
          opt.disabled = true;
          opt.selected = true;
          zielSelect.appendChild(opt);
          return;
        }

        ziele.forEach(z => {
          const opt = document.createElement("option");
          opt.value = z.toLowerCase();
          opt.textContent = z;
          zielSelect.appendChild(opt);
        });
      }

      // initial Zustand
      updateZielOrte();
      startSelect.addEventListener("change", updateZielOrte);
    });
    </script>
{% endblock %}
